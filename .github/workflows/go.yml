name: Go

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ^1.15

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Get dependencies
      ## TODO: Once Go 1.16 releases, try doing universal binaries
      ##       for macOS, eg. Intel + aarch64 in one binary, right?
      ## FIXME: Temporary workaround until Go 1.16 releases
      #run: make deps
      run: |
        go build -v -mod=vendor ./...

    - name: Build
      run: make build

    - name: Test
      run: |
        make test
        make install
        make uninstall

    ## TODO: Signify arch/platform in binary name,
    ##       at least once we do multi-platform builds
    - name: Upload build artifacts
      uses: actions/upload-artifact@v2
      with:
        name: hackchat
        path: hackchat

    - name: Push to GitHub Packages
      id: docker_build
      uses: docker/build-push-action@v2
      with:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        registry: docker.pkg.github.com
        repository: Dids/hackchat/hackchat
        push: true
        tag_with_ref: true # Automatically tag the built Docker image with the Git reference of the workflow event
        # tags: user/app:latest
        # build-args: |
        #   arg1=value1
        #   arg2=value2

    - name: Get image digest
      run: echo ${{ steps.docker_build.outputs.digest }}
